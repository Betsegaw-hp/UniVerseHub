<% 
    let categories = [];
    let posts = [];
    if(data) {
        categories = data.categories;
        posts = data.posts;
    }
%>

<!DOCTYPE html>
<html lang="en">
    <head>
        <%- include('../partials/head')  %> 
        <!-- Include the timeLapse.js file -->
        <script src="/timeLapse.js"></script>
    </head>
    
<body>
    <%- include('../partials/nav')  %>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-8">
                <h1 class="mb-4">UniVerseHub Forums</h1>
                <div class="mb-4">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newTopicModal">
                        <i class="bi bi-plus-circle"></i> Start New Topic
                    </button>
                </div>
                <div class="list-group">
                    <% if (categories.length > 0) { %>
                        <% categories.forEach(category => { %>
                          <a href="forum/category/<%= category.name %>" class="list-group-item list-group-item-action forum-card" >
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1 capitalize"><%= category.name %></h5>
                                <!-- <small>3 new posts</small> -->
                            </div>
                            <p class="mb-1"> <%= category.description %> </p>
                            <small><%= category.postCount %> topics</small>
                          </a>
                        <% }) %>
                      <% } else { %>
                        <p>There is no category to display...</p>
                      <% } %>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header">
                        Recent Topics
                    </div>
                    <ul class="list-group list-group-flush">
                        <% if (posts.length > 0) { %>
                            <!-- the slicing also happens at backend. this is just formality -->
                            <% posts.slice(0,4).forEach(post => {  %>
                                <li class="list-group-item">
                                    <a href="/forum/<%= post._id %>" class="text-decoration-none capitalize">
                                        <%= post.title %>
                                    </a>
                                    <br><small class="text-muted">
                                        by <%= post.author.username %> Â·  <span class="timePassed" data-date="<%= post.createdAt %>"></span>
                                    </small>
                                </li>  
                            <% }) %>
                        <% } else { %>
                            <p>There is no posts to display...</p>
                        <% } %>
                    </ul>
                </div>
                <div class="card">
                    <div class="card-header">
                        Forum Statistics
                    </div>
                    <div class="card-body">
                        <p>Total Members: 15,678</p>
                        <p>Total Topics: 3,490</p>
                        <p>Total Posts: 15,700</p>
                        <p>Online Now: 234</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Topic Modal -->
    <div class="modal fade" id="newTopicModal" tabindex="-1" aria-labelledby="newTopicModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="newTopicModalLabel">Start a New Topic</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="post_form">
                        <div class="mb-3">
                            <label for="topicTitle" class="form-label">Topic Title</label>
                            <input type="text" class="form-control" id="topicTitle" name="title" required>
                        </div>
                        <div class="mb-3">
                            <label for="topicCategory" class="form-label">Category</label>
                            <select class="form-select" id="topicCategory" name="category" required>
                                <option value="">Choose a category...</option>
                                <% if (categories.length > 0) { %>
                                    <% categories.forEach(category => { %>
                                        <option value="<%= category.name %>"><%= category.name %></option>
                                    <% }) %>
                                <% } else { %>
                                    <option value="" disabled>here is no category to display...</option>
                                <% } %>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="topicContent" class="form-label">Content</label>
                            <textarea class="form-control" id="topicContent" rows="5" name="body_content" required></textarea>
                        </div>
                    </form>
                    <div id="form_alert" style="cursor:not-allowed;" class="alert alert-danger fade" role="alert">
                        <p id="alert_msg"></p> 
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" form="post_form" class="btn btn-primary">Post Topic</button>
                </div>
            </div>
        </div>
    </div>

    <%- include('../partials/footer')  %> 


    <script>
        const form = document.querySelector("#post_form");
        const form_alert = document.querySelector("#form_alert");
        const alert_msg = document.querySelector("#alert_msg");

        form.addEventListener("submit", (e) => {
            e.preventDefault();

            const title = form.title.value;
            const body_content = form.body_content.value;
            const category = form.category.value;

            const options = {
               method: "POST",
               headers: { 'Content-Type': 'application/json' },
               body: JSON.stringify({
                 title: title,
                 body_content: body_content,
                 category: category
               })
            }

            fetch("/forum", options)
            .then(res => res.json())
            .then(data => {
                if(data.errors) {
                    form_alert.classList.add('show');
                    let msg = "error occured";
                    if(data.errors.title != '') msg = data.errors.title;
                    else if(data.errors.content != '') msg = data.errors.content;
                    else if(data.errors.category != '') msg = data.errors.category;

                    if(!msg) msg = "Unexpected Error occured. ";
                    alert_msg.textContent = msg;
                    console.log(msg)
                }
                if (data.post) {
                    location.assign('/forum');
                }
            })
            .catch(err => console.error(err));
        });

        form_alert.addEventListener("click", (e) => {
            form_alert.classList.remove('show');
        })
    </script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const timeEle = document.querySelectorAll('.timePassed');
        timeEle.forEach(ele => {
            const createdAt = ele.dataset.date; // Assuming post.createdAt is in ISO format
            const timePassedStr = timePassed(createdAt);
            ele.textContent = timePassedStr
        });
    });
</script>

</body>
</html>