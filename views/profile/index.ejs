<% 
    let userData = user;
    if(!currentUser) {
        userData = otherUser;
    }

    console.log(userData)
%>

<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('../partials/head')  %> 
    <style>
        .profile-header {
            background-color: #f8f9fa;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .profile-avatar {
            width: 150px;
            height: 150px;
            object-fit: cover;
        }
    </style>
    <!-- Include the timeLapse.js file -->
    <script src="/timeLapse.js"></script>
</head>
<body>
    <%- include('../partials/nav')  %>

    <div class="profile-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-3 text-center">
                    <img src="<%= userData.avatarUrl %>" alt="<%= userData.name %>" class="rounded-circle border border-2 border-warning  profile-avatar">
                </div>
                <div class="col-md-9">
                    <h1 class="capitalize"><%= userData.name %></h1>
                    <p class="text-muted small pl-3">@<%= userData.username %></p>
                    <p class="lead"><%= userData.occupation || "Community Member" %></p> 
                    <div class="row">
                        <div class="col-md-3">
                            <i class="bi bi-envelope"></i> <%= userData.email  %></p>
                            <p><i class="bi bi-calendar3"></i> Joined <%= userData.createdAt.toLocaleDateString('en-UK', { year: 'numeric', month: 'long' }) %></p>
                        </div>
                        <div class="col-md-3">
                            <p><i class="bi bi-geo-alt"></i> <%= userData.adderss || "unknown"  %></p>
                        </div>
                    </div>
                    <!-- <button class="btn btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#newProfileModal"><i class="bi bi-pencil"></i> Edit Profile</button> -->
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="row">
            <div class="col-md-3">
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Stats</h5>
                        <ul class="list-unstyled">
                            <li><i class="bi bi-chat-dots"></i> <%= userData.stats.postCount %> Forum Posts</li>
                            <li><i class="bi bi-camera-video"></i> <%= userData.stats.videoCount %> Videos Uploaded</li>
                            <li><i class="bi bi-hand-thumbs-up"></i> 230 Likes Received</li>
                            <li><i class="bi bi-eye"></i> 1,500 Profile Views</li>
                        </ul>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Badges</h5>
                        <div class="d-flex flex-wrap gap-2">
                            <% if( userData.roles.length > 0) { %>
                                <% userData.roles.forEach(role => { %>
                                    <span class="badge bg-primary capitalize"><%= role %></span>
                                <% }); %>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-9">
                <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="posts-tab" data-bs-toggle="tab" data-bs-target="#posts" type="button" role="tab" aria-controls="posts" aria-selected="true">Recent Posts</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="videos-tab" data-bs-toggle="tab" data-bs-target="#videos" type="button" role="tab" aria-controls="videos" aria-selected="false">Recent Videos</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="about-tab" data-bs-toggle="tab" data-bs-target="#about" type="button" role="tab" aria-controls="about" aria-selected="false">About</button>
                    </li>
                </ul>
                <div class="tab-content" id="myTabContent">
                    <div class="tab-pane fade show active" id="posts" role="tabpanel" aria-labelledby="posts-tab">
                        <div class="list-group mb-4">
                            <% if(posts.length > 0) { %>
                                <%
                                const sortedByCreatedAt = posts.sort((a,b) => b.createdAt.valueOf() - a.createdAt.valueOf()); 
                                %>
                                <% sortedByCreatedAt.slice(0,3).map(post => { %>
                                    <a href="/forum/<%= post._id %>" class="list-group-item list-group-item-action topic-card">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h5 class="mb-1 capitalize"><%= post.title %></h5>
                                            <small class="timePassed text-muted" data-date="<%= post.createdAt %>"></small>
                                        </div>
                                        <p class="mb-1 clamp-text"><%= post.content %></p>
                                        <div class="d-flex align-items-center mt-2">
                                            <img src="<%= userData.avatarUrl %>" alt="<%= userData.name %>" class="avatar-sm me-2">
                                            <small class="text-muted">
                                                <i class="bi bi-chat-dots ms-2"></i> <%= post.recentComments.length %> comments
                                                <i class="bi bi-hand-thumbs-up ms-2"></i> <%= post.likeCount %> likes
                                            </small>
                                        </div>
                                    </a>                                   
                                <% }) %>
                            <% } %>
                        </div>
                        <nav aria-label="Topics pagination">
                            <ul class="pagination justify-content-center">
                                <li class="page-item disabled">
                                    <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
                                </li>
                                <li class="page-item active" aria-current="page">
                                    <a class="page-link" href="#">1</a>
                                </li>
                                <li class="page-item"><a class="page-link" href="#">2</a></li>
                                <li class="page-item"><a class="page-link" href="#">3</a></li>
                                <li class="page-item">
                                    <a class="page-link" href="#">Next</a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                    <div class="tab-pane fade" id="videos" role="tabpanel" aria-labelledby="videos-tab">
                        <div class="row">
                            <div class="col-md-4 mb-4">
                                <div class="card">
                                    <img src="/placeholder.svg?height=180&width=320" class="card-img-top" alt="Video thumbnail">
                                    <div class="card-body">
                                        <h5 class="card-title">Day in the life of a CS student</h5>
                                        <p class="card-text"><small class="text-muted">1,200 views · 2 weeks ago</small></p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-4">
                                <div class="card">
                                    <img src="/placeholder.svg?height=180&width=320" class="card-img-top" alt="Video thumbnail">
                                    <div class="card-body">
                                        <h5 class="card-title">Python crash course</h5>
                                        <p class="card-text"><small class="text-muted">3,500 views · 1 month ago</small></p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-4">
                                <div class="card">
                                    <img src="/placeholder.svg?height=180&width=320" class="card-img-top" alt="Video thumbnail">
                                    <div class="card-body">
                                        <h5 class="card-title">5 must-have student apps</h5>
                                        <p class="card-text"><small class="text-muted">2,800 views · 1 month ago</small></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="about" role="tabpanel" aria-labelledby="about-tab">
                        <%= userData.bio %>
                        <h4>About Me</h4>
                        <p>Hi there! I'm John, a junior studying Computer Science at NYU. I'm passionate about web development, machine learning, and creating educational content. When I'm not coding or making videos, you can find me exploring the city or trying out new coffee shops.</p>
                        <h4>Interests</h4>
                        <ul>
                            <li>Web Development (React, Node.js)</li>
                            <li>Machine Learning and AI</li>
                            <li>Video Production</li>
                            <li>Open Source Contributing</li>
                        </ul>
                        <h4>Contact</h4>
                        <p>Feel free to reach out to me for collaborations or just to chat!</p>
                        <p><i class="bi bi-envelope"></i> john.doe@example.com</p>
                        <p><i class="bi bi-linkedin"></i> <a href="#">LinkedIn Profile</a></p>
                        <p><i class="bi bi-github"></i> <a href="#">GitHub Profile</a></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <%- include('../partials/footer')  %>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const timeEle = document.querySelectorAll('.timePassed');
            timeEle.forEach(ele => {
                const createdAt = ele.dataset.date; // Assuming post.createdAt is in ISO format
                const timePassedStr = timePassed(createdAt);
                ele.textContent = timePassedStr;
            });
        });
    </script>
</body>
</html>